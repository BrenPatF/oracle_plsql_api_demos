# Oracle PL/SQL API Demos / Unit Testing for API: Emp_WS.Save_Emps

Oracle PL/SQL API Demos is a module demonstrating instrumentation and logging, code timing and unit testing of Oracle PL/SQL APIs.
- [&uarr; README: Oracle PL/SQL API Demos](https://github.com/BrenPatF/oracle_plsql_api_demos#oracle-plsql-api-demos)

This README covers unit testing for one of the four demo APIs, namely Emp_WS.Save_Emps, using the Math Function Unit Testing design pattern, described here: [Trapit - Oracle PL/SQL unit testing module](https://github.com/BrenPatF/trapit_oracle_tester).

## In this README...
- [Unit Testing Process](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/save_emps/README.md#unit-testing-process)
- [Wrapper Function Signature Diagram](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/save_emps/README.md#wrapper-function-signature-diagram)
- [Unit Test Scenarios](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/save_emps/README.md#unit-test-scenarios)

## Unit Testing Process
- [&uarr; In this README...](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/save_emps/README.md#in-this-readme)

In the Math Function Unit Testing design pattern, a 'pure' wrapper function is constructed that takes all inputs as a parameter, calls the unit under test, and returns the outputs as a single complex value. The driving unit test program is centralized in a library package that calls the specific wrapper function using dynamic SQL (in languages such as Javascript the wrapper would be a callback function), within a loop over scenario records read from a JSON file. The driver writes an output file that contains arrays of expected and actual records by group and scenario in a JSON format. This file is processed by a nodejs program that produces listings of the results in HTML and/or text format.
<div>
<img src="../Oracle PLSQL API Demos - DFD.png" text-align="center" display="inline-block">
</div>

The base procedure, the `unit under test`, has a corresponding unit test wrapper function, both within packages in the app schema/folder:
- `Base procedure`: Emp_WS.Save_Emps
- `Wrapper function`: TT_Emp_WS.Purely_Wrap_Save_Emps

The input JSON file is created by the developer and placed in the Oracle directory `INPUT_DIR`, where the output file is also written. They have been copied here to the `testing\save_emps` folders:
- `Input JSON`: input\tt_emp_ws.purely_wrap_save_emps_inp.json 
- `Output JSON`: output\tt_emp_ws.purely_wrap_save_emps_out.json

An easy way to generate a starting point for the input JSON file is to use a powershell utility [Powershell Utilites module](https://github.com/BrenPatF/powershell_utils) to generate a template file with a single scenario with placeholder records from simple CSV files. The files for this example are in folder `testing\save_emps\input`:
- `Input CSV`: purely_wrap_save_emps_inp.csv
- `Output CSV`: purely_wrap_save_emps_out.csv
- `Powershell script`: purely_wrap_save_emps.ps1
- `Template JSON`: purely_wrap_save_emps_temp.json

The results folder generated by the nodejs program has been copied to the `testing\save_emps\output` folder:
- `Results folder`: oracle-pl_sql-api-demos_-tt_emp_ws.save_emps

## Wrapper Function Signature Diagram
- [&uarr; In this README...](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/save_emps/README.md#in-this-readme)

In the Math Function Unit Testing design pattern the wrapper function includes all inputs and outputs in its signature, including those that are accessed by the `unit under test` through means other than parameters or return value, such as via tables. The inputs and outputs are arranged in groups of records of fixed structure as shown in the diagram, with groups that form part of the `extended` signature in brown. This group structure is reflected in the structure of the input JSON file.

<img src="tt_emp_ws.purely_wrap_save_emps.png">

## Unit Test Scenarios
- [&uarr; In this README...](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/save_emps/README.md#in-this-readme)
- [Input Data Category Sets](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/save_emps/README.md#input-data-category-sets)
- [Scenario Results](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/save_emps/README.md#scenario-results)

The art of unit testing lies in choosing a set of scenarios that will produce a high degree of confidence in the functioning of the unit under test across the often very large range of possible inputs.

A useful approach to this can be to think in terms of categories of inputs, where we reduce large ranges to representative categories. In our case we might consider the following category sets, and create scenarios accordingly:

### Input Data Category Sets
- [&uarr; Unit Test Scenarios](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/save_emps/README.md#unit-test-scenarios)
- [Validity](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/save_emps/README.md#validity)
- [Multiplicity](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/save_emps/README.md#multiplicity)
- [Exceptions](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/save_emps/README.md#exceptions)

#### Validity
- [&uarr; Input Data Category Sets](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/save_emps/README.md#input-data-category-sets)

Check valid and invalid records handled correctly
- Valid
- Invalid

#### Multiplicity
- [&uarr; Input Data Category Sets](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/save_emps/README.md#input-data-category-sets)

Check that both 1 and multiple valid records work, including with an invalid record
- 1 record
- Multiple valid records

#### Exceptions
- [&uarr; Input Data Category Sets](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/save_emps/README.md#input-data-category-sets)

Check that different types of invalid record handled correctly
- Foreign key (job id) error
- Invalid number

### Scenario Results
- [&uarr; Unit Test Scenarios](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/save_emps/README.md#unit-test-scenarios)
- [Results Summary](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/save_emps/README.md#results-summary)
- [Results for Scenario 4: 2 valid records, 1 invalid job id (2 deliberate errors)](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/save_emps/README.md#results-for-scenario-4-2-valid-records-1-invalid-job-id-2-deliberate-errors)

#### Results Summary
- [&uarr; Scenario Results](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/save_emps/README.md#scenario-results)

The summary report in text format shows the scenarios tested:

<pre>
Unit Test Report: Oracle PL/SQL API Demos: TT_Emp_WS.Save_Emps
==============================================================

      #    Scenario                                                 Fails (of 3)  Status 
      ---  -------------------------------------------------------  ------------  -------
      1    1 valid record                                           0             SUCCESS
      2    1 invalid job id                                         0             SUCCESS
      3    1 invalid number                                         0             SUCCESS
      4*   2 valid records, 1 invalid job id (2 deliberate errors)  1             FAILURE

Test scenarios: 1 failed of 4: FAILURE
======================================
</pre>

You can review the formatted unit test results here, [Unit Test Report: Oracle PL/SQL API Demos: TT_Emp_WS.Save_Emps](http://htmlpreview.github.io/?https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/save_emps/output/oracle-pl_sql-api-demos_-tt_emp_ws.save_emps/oracle-pl_sql-api-demos_-tt_emp_ws.save_emps.html), and the files are available in the `testing\save_emps\output\oracle-pl_sql-api-demos_-tt_emp_ws.save_emps` subfolder :
- `HTML root page`: oracle-pl_sql-api-demos_-tt_emp_ws.save_emps.html
- `Text file`: oracle-pl_sql-api-demos_-tt_emp_ws.save_emps.txt

#### Results for Scenario 4: 2 valid records, 1 invalid job id (2 deliberate errors)
- [&uarr; Scenario Results](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/save_emps/README.md#scenario-results)

<pre>
SCENARIO 4: 2 valid records, 1 invalid job id (2 deliberate errors) {
=====================================================================

   INPUTS
   ======

      GROUP 1: Employee {
      ===================

            #  Name  Email  Job      Salary
            -  ----  -----  -------  ------
            1  LN 4  EM 4   IT_PROG  3000  
            2  LN 5  EM 5   NON_JOB  4000  
            3  LN 6  EM 6   IT_PROG  5000  

      }
      =

   OUTPUTS
   =======

      GROUP 1: Employee {
      ===================

            #   Employee id  Name  Email  Job      Salary
            --  -----------  ----  -----  -------  ------
            1   1            LN 4  EM 4   IT_PROG  1000  
            1*  1            LN 4  EM 4   IT_PROG  3000  
            2   3            LN 6  EM 6   IT_PROG  5000  
            3   3            LN 6  EM 6   IT_PROG  5000  
            3*  *NO RECORD*                              

      } 2 failed of 3: FAILURE
      ========================

      GROUP 2: Output array {
      =======================

            #  Employee id  Description                                                        
            -  -----------  -------------------------------------------------------------------
            1  1            LIKE /^[A-Z -]+[A-Z]$/: SEVEN HUNDRED SIXTY-NINE                   
            2  0            ORA-02291: integrity constraint (.) violated - parent key not found
            3  3            LIKE /^[A-Z -]+[A-Z]$/: SEVEN HUNDRED SEVENTY-ONE                  

      } 0 failed of 3: SUCCESS
      ========================

      GROUP 3: Exception: Empty as expected: SUCCESS
      ==============================================

} 1 failed of 3: FAILURE
========================
</pre>
