# Oracle PL/SQL API Demos / Unit Testing for API: Emp_WS.Get_Dept_Emps

Oracle PL/SQL API Demos is a module demonstrating instrumentation and logging, code timing and unit testing of Oracle PL/SQL APIs.
- [&uarr; README: Oracle PL/SQL API Demos / Unit Testing](https://github.com/BrenPatF/oracle_plsql_api_demos#unit-testing)

This README covers unit testing for one of the four demo APIs, namely Emp_WS.Get_Dept_Emps, using the Math Function Unit Testing design pattern, described here: [Trapit - Oracle PL/SQL unit testing module](https://github.com/BrenPatF/trapit_oracle_tester).

## In this README...
- [Unit Testing Process](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/get_dept_emps/README.md#unit-testing-process)
- [Wrapper Function Signature Diagram](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/get_dept_emps/README.md#wrapper-function-signature-diagram)
- [Unit Test Scenarios](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/get_dept_emps/README.md#unit-test-scenarios)

## Unit Testing Process
- [&uarr; In this README...](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/get_dept_emps/README.md#in-this-readme)

In the Math Function Unit Testing design pattern, a 'pure' wrapper function is constructed that takes all inputs as a parameter, calls the unit under test, and returns the outputs as a single complex value. The driving unit test program is centralized in a library package that calls the specific wrapper function using dynamic SQL (in languages such as Javascript the wrapper would be a callback function), within a loop over scenario records read from a JSON file. The driver writes an output file that contains arrays of expected and actual records by group and scenario in a JSON format. This file is processed by a nodejs program that produces listings of the results in HTML and/or text format.
<div>
<img src="../Oracle PLSQL API Demos - DFD.png" text-align="center" display="inline-block">
</div>

The base procedure, the `unit under test`, has a corresponding unit test wrapper function, both within packages in the app schema/folder:
- `Base procedure`: Emp_WS.Get_Dept_Emps
- `Wrapper function`: TT_Emp_WS.Purely_Wrap_Get_Dept_Emps

The input JSON file is created by the developer and placed in the Oracle directory `INPUT_DIR`, where the output file is also written. They have been copied here to the `testing\get_dept_emps` folders:
- `Input JSON`: input\tt_emp_ws.purely_wrap_get_dept_emps_inp.json 
- `Output JSON`: output\tt_emp_ws.purely_wrap_get_dept_emps_out.json

An easy way to generate a starting point for the input JSON file is to use a powershell utility [Powershell Utilites module](https://github.com/BrenPatF/powershell_utils) to generate a template file with a single scenario with placeholder records from simple CSV files. The files for this example are in folder `testing\get_dept_emps\input`:
- `Input CSV`: purely_wrap_get_dept_emps_inp.csv
- `Output CSV`: purely_wrap_get_dept_emps_out.csv
- `Powershell script`: purely_wrap_get_dept_emps.ps1
- `Template JSON`: purely_wrap_get_dept_emps_temp.json

The results folder generated by the nodejs program has been copied to the `testing\get_dept_emps\output` folder:
- `Results folder`: oracle-pl_sql-api-demos_-tt_emp_ws.get_dept_emps

## Wrapper Function Signature Diagram
- [&uarr; In this README...](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/get_dept_emps/README.md#in-this-readme)

In the Math Function Unit Testing design pattern the wrapper function includes all inputs and outputs in its signature, including those that are accessed by the `unit under test` through means other than parameters or return value, such as via tables. The inputs and outputs are arranged in groups of records of fixed structure as shown in the diagram, with groups that form part of the `extended` signature in brown. This group structure is reflected in the structure of the input JSON file.

<img src="tt_emp_ws.purely_wrap_get_dept_emps.png">

## Unit Test Scenarios
- [&uarr; In this README...](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/get_dept_emps/README.md#in-this-readme)
- [Input Data Category Sets](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/get_dept_emps/README.md#input-data-category-sets)
- [Scenario Results](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/get_dept_emps/README.md#scenario-results)

The art of unit testing lies in choosing a set of scenarios that will produce a high degree of confidence in the functioning of the unit under test across the often very large range of possible inputs.

A useful approach to this can be to think in terms of categories of inputs, where we reduce large ranges to representative categories. In our case we might consider the following category sets, and create scenarios accordingly:

### Input Data Category Sets
- [&uarr; Unit Test Scenarios](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/get_dept_emps/README.md#unit-test-scenarios)
- [Parameter (department)](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/get_dept_emps/README.md#parameter-department)
- [Joins](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/get_dept_emps/README.md#joins)
- [Constraints](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/get_dept_emps/README.md#constraints)
- [Expressions](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/get_dept_emps/README.md#expressions)

#### Parameter (department)
- [&uarr; Input Data Category Sets](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/get_dept_emps/README.md#input-data-category-sets)

Check department parameter handled correctly
- Passed (only that department output)
- Not passed (no records)

#### Joins
- [&uarr; Input Data Category Sets](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/get_dept_emps/README.md#input-data-category-sets)

Check that both inner and outer joins exclude or include records as appropriate
- Inner (department) excludes employees without matching department
- Outer (manager) includes employees without matching manager

#### Constraints
- [&uarr; Input Data Category Sets](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/get_dept_emps/README.md#input-data-category-sets)

Check that constraints exclude records correctly
- Exclude job 'AD_ASST'
- Exclude where salary ratio overall < 1600

#### Expressions
- [&uarr; Input Data Category Sets](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/get_dept_emps/README.md#input-data-category-sets)

Check that analytic and other expressions are calculated correctly
- Salary ratio by department
- Salary ratio overall

### Scenario Results
- [&uarr; Unit Test Scenarios](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/get_dept_emps/README.md#unit-test-scenarios)
- [Results Summary](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/get_dept_emps/README.md#results-summary)
- [Results for Scenario 1: DS-1, testing inner, outer joins, analytic over dep, and global ratios with 1 dep (10) - pass dep 10](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/get_dept_emps/README.md#results-for-scenario-1-ds-1-testing-inner-outer-joins-analytic-over-dep-and-global-ratios-with-1-dep-10---pass-dep-10)

#### Results Summary
- [&uarr; Scenario Results](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/get_dept_emps/README.md#scenario-results)

The summary report in text format shows the scenarios tested:

<pre>
Unit Test Report: Oracle PL/SQL API Demos: TT_Emp_WS.Get_Dept_Emps
==================================================================

      #    Scenario                                                                                              Fails (of 2)  Status 
      ---  ----------------------------------------------------------------------------------------------------  ------------  -------
      1    DS-1, testing inner, outer joins, analytic over dep, and global ratios with 1 dep (10) - pass dep 10  0             SUCCESS
      2    DS-2, testing same as 1 but with extra emp in another dep (20) - pass dep 10                          0             SUCCESS
      3    DS-2, as second scenario, but - pass dep 20                                                           0             SUCCESS
      4    DS-2, as second scenario, but - pass null dep                                                         0             SUCCESS
      5    DS-3, Salaries total 1500 (< threshold of 1600, so return nothing) - pass dep 10                      0             SUCCESS

Test scenarios: 0 failed of 5: SUCCESS
======================================
</pre>

You can review the formatted unit test results here, [Unit Test Report: Oracle PL/SQL API Demos: TT_Emp_WS.Get_Dept_Emps](http://htmlpreview.github.io/?https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/get_dept_emps/output/oracle-pl_sql-api-demos_-tt_emp_ws.get_dept_emps/oracle-pl_sql-api-demos_-tt_emp_ws.get_dept_emps.html), and the files are available in the `testing\get_dept_emps\output\oracle-pl_sql-api-demos_-tt_emp_ws.get_dept_emps` subfolder :
- `HTML root page`: oracle-pl_sql-api-demos_-tt_emp_ws.get_dept_emps.html
- `Text file`: oracle-pl_sql-api-demos_-tt_emp_ws.get_dept_emps.txt

#### Results for Scenario 1: DS-1, testing inner, outer joins, analytic over dep, and global ratios with 1 dep (10) - pass dep 10
- [&uarr; Scenario Results](https://github.com/BrenPatF/oracle_plsql_api_demos/blob/master/testing/get_dept_emps/README.md#scenario-results)

<pre>
SCENARIO 1: DS-1, testing inner, outer joins, analytic over dep, and global ratios with 1 dep (10) - pass dep 10 {
==================================================================================================================

   INPUTS
   ======

      GROUP 1: Employee {
      ===================

            #  Employee Id  Last Name  Email  Hire Date    Job      Salary  Manager Id  Department Id  Updated    
            -  -----------  ---------  -----  -----------  -------  ------  ----------  -------------  -----------
            1  1            LN_1       EM_1   17-JUN-2018  IT_PROG  1000                10             17-JUN-2018
            2  2            LN_2       EM_2   17-JUN-2018  IT_PROG  2000    1           10             17-JUN-2018
            3  3            LN_3       EM_3   17-JUN-2018  IT_PROG  3000    1                          17-JUN-2018
            4  4            LN_4       EM_4   17-JUN-2018  AD_ASST  4000    1           10             17-JUN-2018

      }
      =

      GROUP 2: Department Parameter {
      ===============================

            #  Department Id
            -  -------------
            1  10           

      }
      =

   OUTPUTS
   =======

      GROUP 1: Select results {
      =========================

            #  Name  Department      Manager  Salary  Salary Ratio (dep)  Salary Ratio (overall)
            -  ----  --------------  -------  ------  ------------------  ----------------------
            1  LN_1  Administration           1000    .67                 .4                    
            2  LN_2  Administration  LN_1     2000    1.33                .8                    

      } 0 failed of 2: SUCCESS
      ========================

      GROUP 2: Unhandled Exception: Empty as expected: SUCCESS
      ========================================================

} 0 failed of 2: SUCCESS
========================
</pre>
